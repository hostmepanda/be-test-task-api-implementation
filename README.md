# Test task: implement Backend API 

Current repository contains an implementation of the backend API according to the requirements
provided in the [DEEL BACKEND TASK description](./TASK.README.md).

Critical issues for several packages (e.g. `nodmon`) were applied. Based on data received from `npm audit`.

### List of implemented API resources:
- `GET /contracts/:id` returns the contract only if it belongs to the profile calling
- `GET /contracts` returns a list of contracts belonging to a user (client or contractor), the list only contains non terminated contracts.
- `GET /jobs/unpaid` returns all unpaid jobs for a user (either a client or contractor), for active contracts only.
- `POST /jobs/:job_id/pay` moves amount equals to the job price from a client's balance to a contractor's balance and marks the job as `paid`.
- `POST /balances/deposit/:userId` deposits money into the balance of a client, a client can't deposit more than 25% his total of jobs to pay (at the deposit moment).
- `GET /admin/best-profession?start=<date>&end=<date>` returns the profession that earned the most money for any contactor that worked in the query time range.
- `GET /admin/best-clients?start=<date>&end=<date>&limit=<integer>` returns the clients the paid the most for jobs in the query time period.

## Technical details
- Application runs using [`nodejs`](https://github.com/nodejs/node);
- In the core of the application [`expressjs`](https://expressjs.com/) framework.
- As a database layer the Sequelize ORM tool is used, actual store is [`sqlite`](https://www.sqlite.org/index.html) though.
- [`ioredis`](https://github.com/luin/ioredis) and [`redlock`](https://github.com/mike-marcacci/node-redlock) are used to manage locks within models update operations.
- Unit tests are built upon [`jest`](https://jestjs.io/) testing library.
- Documentation is generated with help of the [`swagger-autogen`](https://github.com/davibaltar/swagger-autogen).
- To maintain code style (airbnb code style) [`eslint`](https://github.com/eslint/eslint) is used.

## Start application and run test
To start the application a `Redis` connection is required. Docker compose file can be used to deploy redis and nodejs locally or in pod environment.

#### Start application command
```shell
npm run start
```

#### Run test and see test-coverage
```shell
npm run test
```

#### Run application in development mode using nodemon
```shell
npm run dev
```

### Accessing the documentation
Documentation generated by `swagger-autogen` is served over `expressjs` route `/doc`.
1. Start the application `npm run start` or `npm run dev`
2. Navigate to [`http://localhost:3001/doc`](http://localhost:3001/doc)

### Environment variables
- `REDIS_HOST`, default value `localhost`;
- `REDIS_HOST`, default value `6379`;
- `SEQUELIZE_DIALECT`, default value `sqlite`;
- `SEQUELIZE_STORAGE_PATH`, default value `${rootPath}/database.sqlite3`;

### Further improvements
- Use real database (or in-memory sqlite location) to have more fair unit test;
- Use async logging solution like [`winston`](https://github.com/winstonjs/winston) or [`bunyan`](https://github.com/trentm/node-bunyan) to log the errors thrown in some handlers;
- Use more neat approach with locks in update ops;
- Use transactions in the `jobHandler.payById()` method; 